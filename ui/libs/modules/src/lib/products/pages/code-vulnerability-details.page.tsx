import {
  ConfirmationModal,
  InfoCardProps,
  ModalForm,
  ProductDataGridPage,
  TWorkItem,
} from '@tauruseer/core';

import {
  ACCEPT_RISK_INTENT,
  IProducts,
  TCodeVulnerability,
  VulnerabilityRemediationAICard,
  codeVulnerabilityContent,
  codeVulnerabilityDetailsBreadcrumbData,
} from '@tauruseer/module';

import { InfoCard } from '@tauruseer/core';
import { useFetcher } from '@remix-run/react';
import { useEffect, useState } from 'react';
import { AcceptRiskModal } from '../components/common/modals/accept-risk-modal.component';

type TCodeVulnerabilityDetailsProps = {
  productId: string;
  product: IProducts;
  codeVulnerability: TCodeVulnerability;
  codeVulnerabilityDescription: string;
  workItem: TWorkItem | null;
  aiRemediation?: {
    cve: string;
    remediationDescription: string;
    language: string;
  }[];
};

export const CodeVulnerabilityDetails = ({
  product,
  productId,
  codeVulnerability,
  codeVulnerabilityDescription,
  workItem,
  aiRemediation,
}: TCodeVulnerabilityDetailsProps) => {
  const fetcher = useFetcher();
  const [isLoading, setIsLoading] = useState<boolean>(false);
  const [showConfirmationModal, setShowConfirmationModal] = useState<boolean>(false);
  const [showExpandModal, setShowExpandModal] = useState<boolean>(false);

  const [selectedInstanceId, setSelectedInstanceId] = useState<number[]>([]);

  const acceptRiskHandler = async () => {
    if (!isLoading) {
      setIsLoading(true);
      console.log(selectedInstanceId);
      fetcher.submit(
        // Intent is checked in the page actions
        {
          intent: ACCEPT_RISK_INTENT,
          instanceId: JSON.stringify(selectedInstanceId),
        },
        { method: 'post' },
      );
    }
  };

  useEffect(() => {
    if (isLoading && fetcher.data) {
      setShowConfirmationModal(false);
      setIsLoading(false);
    }
  }, [isLoading, fetcher.data]);

  const content: InfoCardProps = codeVulnerabilityContent({
    productId,
    codeVulnerability,
    codeVulnerabilityDescription,
    onAcceptRisk: (instanceId) => {
      setSelectedInstanceId([Number(instanceId)]);
      setShowConfirmationModal(true);
    },
    product,
    workItem,
    onExpandModal: () => setShowExpandModal(true),
    onAcceptMultipleRisks(instanceIds) {
      setSelectedInstanceId(instanceIds);
      setShowConfirmationModal(true);
    },
  });

  return (
    <ProductDataGridPage
      breadcrumbData={codeVulnerabilityDetailsBreadcrumbData({
        productId: productId,
        codeVulnerabilityId: codeVulnerability.message ?? '',
        productName: product.name ?? '',
      })}
      product={product}
    >
      <div className="row">
        <div className="col-12">
          <InfoCard content={content}></InfoCard>{' '}
        </div>
      </div>
      {aiRemediation && (
        <div className="row">
          <div className="col-12">
            <VulnerabilityRemediationAICard
              markdown={aiRemediation[0]?.remediationDescription ?? ''}
              loading={false}
              language={'javascript'}
            />
          </div>
        </div>
      )}
      {showConfirmationModal && (
        <AcceptRiskModal
          onClose={() => setShowConfirmationModal(false)}
          onConfirm={() => acceptRiskHandler()}
          isLoading={isLoading}
          multiple={selectedInstanceId.length > 1}
          data={
            content.table?.data.filter((item) =>
              selectedInstanceId.find((instanceId) => instanceId === item['id']),
            ) ?? []
          }
          fields={content.table?.confirmationFields ?? []}
        />
      )}
      {showExpandModal && content.textbox && (
        <ModalForm
          title={content.header.title}
          onClose={() => setShowExpandModal(false)}
          width={1000}
        >
          <div
            className="code-vulnerabilities-expand-modal"
            style={{ maxHeight: 'calc(100vh - 300px)', overflowY: 'auto' }}
            dangerouslySetInnerHTML={{ __html: content.textbox.html ?? '' }}
          />
        </ModalForm>
      )}
    </ProductDataGridPage>
  );
};
